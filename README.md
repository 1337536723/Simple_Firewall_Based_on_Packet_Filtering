#基于包过滤的简易防火墙实现

首先复习一下:

> 问：防火墙是什么？

> 答：防火墙是由不燃烧体构成，耐火极限不低于3h。为减小或避免建筑、结构、设备遭受热辐射危害和防止火灾蔓延，设置的竖向分隔体或直接设置在建筑物基础上或钢筋混凝土框架上具有耐火性的墙。

![壮哉我大长城](https://raw.githubusercontent.com/familyld/Simple_Firewall_Based_on_Packet_Filtering/master/graph/gfw.jpg)

这都信，you are too young.

在网络安全中，我们所说的防火墙是指一种 `置于不同网络之间` `执行访问控制策略` 从而 `保护本地网络安全` 的 `一组硬件和软件系统`，它是**不同网络间通信流的唯一通道**，能根据企业有关的安全政策控制进出网络的访问行为（如允许、拒绝、监视、记录等）。

> 问：那防火墙具体能做什么呢？

> 答：大致如下

> - 实现安全机制，监控安全相关行为
>       - 过滤进出网络的数据包
>       - 管理进出网络的访问行为并封堵某些禁止的访问行为
>       - 记录通过防火墙的信息内容和活动（所以你做了什么不可描述的事情，CIO是可以知道的噢）
>       - 对网络攻击进行检测和告警

> - 提供强有力的身份验证
>       - 辨别用户身份并根据其身份提供网络服务
>       - 比方说Boss上班可以看看youtube，你上班就只能老老实实工作

> - 提供VPN(virtual private networks) 服务
>       - 在不安全的互联网上提供一个虚拟专用网络，使得远程访问时，能够保证企业机密数据的安全

特别地，防火墙提供的是一种双向的保护，既阻止外部网络对本地网络的非法访问和入侵，又控制了本地网络对外部不良网络的访问或未经允许的数据输出，从而有效地防止内部信息的泄露。

> 问：那防火墙什么时候会失手呢？

> 答：一是绕开防火墙的攻击，也即旁路(bypass)；二是内部威胁，比方说公司内部出了个内奸，它把机密数据拷到U盘上带出去，这是防火墙阻止不了的；三是病毒，防火墙检查一般是检查源、目的地址和端口号，所以如果病毒在传输的数据上做文章，防火墙是难以防御的。

#项目架构分析
原项目是由一位网名为sudhirmangla的印度工程师和他的朋友共同完成并开源的，[项目地址](http://www.codeproject.com/Articles/5602/Simple-Packet-Filter-Firewall?msg=1635599#xx1635599xx)。界面如下：

![完整版界面](http://www.csc.villanova.edu/~vbhardwa/netclass/Firewall_files/image002.jpg)

但这次实验采用的是~~阉割版~~的代码，要求在Windows XP下实现一个基于MFC的包过滤防火墙，包含以下功能：

- 直接过滤进、出本机所有的数据包；
- 能够选择过滤进、出本机的某一种类数据包；
- 用户可以自己添加过滤规则：对指定端口、指定源地址、指定目的地址的指定类型的数据包进行指定的操作；
- 程序具备良好的健壮性、可用性；
- 除以下功能外再加入一些创新的功能；

架构图如下：

![架构](https://raw.githubusercontent.com/familyld/Simple_Firewall_Based_on_Packet_Filtering/master/graph/How_it_Works.png)

其中Hook可以理解为用户模式到网卡驱动之间一个沟通的渠道，或者说是一个系统服务。当我们需要让网卡驱动做用户设定的某件任务(比如开始过滤)时，首先要把任务转化为一个系统服务，然后把这个系统服务在系统数据库中进行注册，然后开启网卡驱动的IO流，最后把服务写进去使其生效。

整个项目可以分为底层文件和应用层文件两部分，底层文件负责和底层驱动的交互，应用层文件则负责与用户界面的交互。因为应用层功能实现上的代码被~~阉割~~了，所以需要对缺失函数进行填充才能实现功能。
